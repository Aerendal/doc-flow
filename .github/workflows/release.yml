name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build.yml

  sbom:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (CycloneDX)
        uses: CycloneDX/gh-gomod-generate-sbom@v2
        with:
          output: sbom.cdx.json
          args: mod -licenses -json
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.cdx.json

  attest_provenance:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_all
      - name: Attest build provenance (archives)
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            dist_all/**/*.tar.gz
            dist_all/**/*.zip

  release:
    needs: [build, sbom]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
      - name: Generate changelog
        shell: bash
        run: |
          set -euo pipefail
          prev="$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || true)"
          if [ -n "$prev" ]; then
            echo "Changes since $prev" > CHANGELOG_RELEASE.txt
            echo "" >> CHANGELOG_RELEASE.txt
            git log --pretty=format:"- %h %s" "$prev"..HEAD >> CHANGELOG_RELEASE.txt
          else
            git log --pretty=format:"- %h %s" -n 50 > CHANGELOG_RELEASE.txt
          fi
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_all
      - name: Download SBOM
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: dist_all
      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release_assets
          declare -A seen
          while IFS= read -r -d '' f; do
            base="$(basename "$f")"
            if [[ -n "${seen[$base]:-}" ]]; then
              echo "duplicate artifact basename: $base" >&2
              exit 1
            fi
            seen["$base"]=1
            cp "$f" "release_assets/$base"
          done < <(find dist_all -type f \( -name "*.tar.gz" -o -name "*.zip" \) -print0 | sort -z)
          if [[ -f "dist_all/sbom.cdx.json" ]]; then
            cp dist_all/sbom.cdx.json release_assets/sbom.cdx.json
          fi
          if ! find release_assets -maxdepth 1 -type f \( -name "*.tar.gz" -o -name "*.zip" \) -print -quit | grep -q .; then
            echo "no release archives found after prepare step" >&2
            exit 1
          fi
      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd release_assets
          find . -maxdepth 1 -type f \( -name "*.tar.gz" -o -name "*.zip" \) -print0 \
            | sort -z \
            | xargs -0 sha256sum \
            | sed 's|  \./|  |' > checksums.txt
          test -s checksums.txt
      - name: Show release files
        shell: bash
        run: |
          set -euo pipefail
          find release_assets -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "checksums.txt" -o -name "sbom.cdx.json" \) | sort
      - name: Detect optional assets
        id: optional_assets
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "release_assets/sbom.cdx.json" ]; then
            echo "has_sbom=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_sbom=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_assets/*.tar.gz
            release_assets/*.zip
            release_assets/checksums.txt
          fail_on_unmatched_files: true
          body_path: CHANGELOG_RELEASE.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload SBOM asset
        if: steps.optional_assets.outputs.has_sbom == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/sbom.cdx.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sign_cosign:
    needs: [build, release]
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
      - name: Download release assets (archives)
        uses: actions/download-artifact@v4
        with:
          path: dist_all
      - name: Prepare signing assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release_assets
          declare -A seen
          while IFS= read -r -d '' f; do
            base="$(basename "$f")"
            if [[ -n "${seen[$base]:-}" ]]; then
              echo "duplicate artifact basename: $base" >&2
              exit 1
            fi
            seen["$base"]=1
            cp "$f" "release_assets/$base"
          done < <(find dist_all -type f \( -name "*.tar.gz" -o -name "*.zip" \) -print0 | sort -z)
          cd release_assets
          find . -maxdepth 1 -type f \( -name "*.tar.gz" -o -name "*.zip" \) -print0 \
            | sort -z \
            | xargs -0 sha256sum \
            | sed 's|  \./|  |' > checksums.txt
          test -s checksums.txt
      - name: Cosign sign archives + checksums
        shell: bash
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(release_assets/*.tar.gz release_assets/*.zip release_assets/checksums.txt)
          for f in "${files[@]}"; do
            [ -f "$f" ] || continue
            cosign sign-blob \
              --output-signature "${f}.sig" \
              --output-certificate "${f}.cert" \
              "$f"
          done
      - name: Upload signatures artifact
        uses: actions/upload-artifact@v4
        with:
          name: cosign-signatures
          path: |
            release_assets/*.sig
            release_assets/*.cert
      - name: Upload signatures to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_assets/*.sig
            release_assets/*.cert
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
